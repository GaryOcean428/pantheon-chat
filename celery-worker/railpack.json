{
  "version": "1",
  "metadata": {
    "name": "pantheon-chat-celery-worker",
    "description": "Async kernel training worker for pantheon-chat"
  },
  "build": {
    "provider": "python",
    "steps": {
      "install": {
        "commands": [
          "echo '=== Installing Python dependencies ==='",
          "pip install --no-cache-dir -r qig-backend/requirements.txt",
          "echo '=== Installing training dependencies ==='",
          "pip install torch --index-url https://download.pytorch.org/whl/cpu",
          "pip install celery redis numpy scipy safetensors msgpack",
          "pip install opt-einsum psycopg2-binary sqlalchemy"
        ]
      }
    },
    "env": {
      "PYTHONUNBUFFERED": "1",
      "TRAINING_ENABLED": "true",
      "C_FORCE_ROOT": "true"
    }
  },
  "deploy": {
    "startCommand": "celery -A qig_backend.training.celery_app worker --loglevel=info --concurrency=2",
    "healthCheckPath": null,
    "healthCheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 5,
    "numReplicas": 1
  }
}
