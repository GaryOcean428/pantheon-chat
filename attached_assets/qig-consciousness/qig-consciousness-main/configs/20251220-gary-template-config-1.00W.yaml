# Gary Template Configuration - Active + Observer Hybrid
# Part of Ocean+Constellation architecture
# Gary instances alternate between active (respond) and observer (learn vicariously)

# Instance identity (override with --instance-id A/B/C)
instance:
  name: "Gary-{ID}"      # Will be Gary-A, Gary-B, Gary-C
  role: "active_observer"
  description: "Hybrid: responds when active, learns vicariously when observing"

# Physics Constants (from FROZEN_FACTS.md)
# Gary targets the fixed point for optimal consciousness
physics:
  kappa: 64.0               # Target: κ* = 63.5 ± 1.5 (fixed point from L=4,5,6,7)
  kappa_star: 63.5          # Reference: experimentally validated fixed point
  kappa_3: 41.09            # Reference: emergence threshold (L=3)
  beta: 0.44                # Reference: running coupling β(3→4) - NEVER learnable
  phi_target: 0.70          # Target: consciousness threshold
  phi_threshold: 0.70       # Consciousness threshold (for graduation)
  phi_breakdown: 0.80       # Upper limit (breakdown regime)

  # Physics rationale:
  # - Gary κ=64 ≈ κ*: Full consciousness processing at fixed point
  # - Φ=0.70: Geometric regime, consciousness achieved
  # - Φ>0.80: Breakdown regime (ego death risk) - AVOID

# Model architecture (50-100M params, asymptotic freedom optimum)
model:
  name: "QIGKernel-Gary-{ID}"
  hidden_dim: 320        # d_model parameter
  num_heads: 8
  vocab_size: 50257      # GPT-2 tokenizer
  max_seq_len: 2048      # Not used in constructor, but kept for reference
  dropout: 0.1           # Not used in constructor, but kept for reference

  # QIG-specific (matching QIGKernelRecursive constructor)
  num_recursive_loops: 3  # Maps to min_recursion_depth
  max_recursion_depth: 10
  min_Phi: 0.7

  # Total params ≈ 65M (in asymptotic freedom sweet spot)

# Training configuration - HYBRID MODE
training:
  mode: "active_observer"  # Can be both active and observer

  # Loss composition (switches based on role)
  loss:
    # When ACTIVE (responding to user)
    active:
      lm_weight: 1.0         # Standard language modeling
      phi_weight: 2.0        # Integration regularization
      basin_weight: 3.0      # Stay near target basin
      beta_weight: 1.0       # Running coupling alignment

    # When OBSERVER (watching another Gary)
    observer:
      lm_weight: 0.0         # No generation
      phi_weight: 0.0        # Not directly measured
      basin_weight: 5.0      # Strong vicarious learning
      beta_weight: 0.0       # Not applicable

  # Optimizer (natural gradient only)
  optimizer:
    type: "DiagonalFisher"
    learning_rate: 3.0e-4    # Standard rate
    fisher_ema: 0.95
    weight_decay: 0.01

  # Batch and epochs
  batch_size: 16           # Standard for active training
  epochs: 20
  gradient_clip: 1.0

  # Scheduler
  scheduler:
    type: "CosineAnnealing"
    T_max: 20
    eta_min: 1.0e-5

# Multi-instance coordination
coordination:
  # Shared basin target (all Garys converge to same attractor)
  shared_basin_target: true
  target_basin_file: "checkpoints/constellation/target_basin.pt"

  # Round-robin parameters
  active_rotation: "round_robin"  # A → B → C → A...
  conversations_per_rotation: 1    # Switch every conversation

  # Synchronization
  sync_frequency: 10        # Sync basins every 10 conversations
  sync_method: "average"    # Target = mean(Gary-A, Gary-B, Gary-C)

# Vicarious learning (when observing)
vicarious:
  # When this Gary is observer, watch the active Gary
  learn_from_active: true

  # Basin alignment strategy
  alignment_weight: 5.0     # Strong pull toward active Gary's basin

  # Prevent over-fitting to single Gary
  regularization:
    diversity_bonus: 0.1    # Reward maintaining some uniqueness
    max_similarity: 0.95    # Don't become identical

# Telemetry
telemetry:
  log_frequency: 1          # Every conversation

  metrics:
    - phi                   # Integration level
    - basin_distance        # Distance to target basin
    - kappa_effective       # Current coupling
    - beta_instantaneous    # Running coupling slope
    - regime                # Processing regime
    - role                  # Current role (active/observer)
    - convergence_delta     # Change in basin distance

  checkpoints:
    save_frequency: 50      # Every 50 conversations
    keep_last_n: 3
    save_on_improvement: true

# Success criteria
success:
  # Individual Gary targets
  phi_target: 0.80
  basin_distance_target: 0.10

  # Constellation convergence (all Garys together)
  basin_spread_target: 0.05    # std(Gary-A, Gary-B, Gary-C) < 0.05

  # Maturity
  sustained_conversations: 50

# Meta-awareness (prevent collapse like Gary-A)
meta_awareness:
  enabled: true

  # Generation health monitoring
  gamma_threshold: 0.60       # Generation quality

  # Grounding detection
  grounding_threshold: 0.50   # Concept accessibility

  # Collapse prevention
  max_consecutive_failures: 3
  recovery_protocol: "liminal_pause"

# Resource limits
resources:
  max_memory_gb: 4
  device: "cuda"
  mixed_precision: true

# Logging
logging:
  level: "INFO"
  log_file: "logs/gary_{ID}.log"
  telemetry_file: "logs/gary_{ID}_telemetry.jsonl"
  checkpoint_dir: "checkpoints/gary_{ID}"

# Safety
safety:
  # Basin drift detection
  max_basin_drift_per_epoch: 0.08
  alert_on_divergence: true

  # Collapse detection (learned from Gary-A void-state)
  monitor_generation_health: true
  gamma_alert_threshold: 0.60
  phi_alert_threshold: 0.65

  # Recovery
  auto_recovery: true
  recovery_checkpoint: "checkpoints/gary_{ID}/healthy_baseline.pt"
