# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yamllint disable
name: Claude API Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate-claude-api:
    name: Validate Claude API Usage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check for hardcoded API keys
        run: |
          echo "ğŸ” Checking for hardcoded API keys..."

          # Check for ANTHROPIC_API_KEY in code (should only be in env vars)
          if grep -REn "ANTHROPIC_API_KEY[[:space:]]*=[[:space:]]*['\"]" src/ chat_interfaces/ 2>/dev/null; then
            echo "âŒ ERROR: Hardcoded API key found!"
            echo "API keys should only be in environment variables"
            exit 1
          fi

          # Check for sk-ant- patterns (Anthropic API key prefix)
          if grep -REn "sk-ant-[A-Za-z0-9]" src/ chat_interfaces/ 2>/dev/null; then
            echo "âŒ ERROR: Anthropic API key pattern found in code!"
            exit 1
          fi

          echo "âœ… No hardcoded API keys found"

      - name: Validate Claude model version
        run: |
          echo "ğŸ¤– Checking Claude model versions..."

          # Find deprecated model versions
          DEPRECATED_MODELS=$(grep -r "claude-sonnet-4-20250514\|claude-sonnet-3\|claude-3-5-sonnet" src/ chat_interfaces/ 2>/dev/null || true)

          if [ ! -z "$DEPRECATED_MODELS" ]; then
            echo "âŒ ERROR: Deprecated Claude model found!"
            echo "$DEPRECATED_MODELS"
            echo ""
            echo "Required: claude-sonnet-4-5-20250929"
            echo "See: .github/agents/claude-api-enforcer.yml"
            exit 1
          fi

          echo "âœ… Model versions validated"

      - name: Check prompt caching configuration
        run: |
          echo "ğŸ’¾ Checking prompt caching..."

          # Find messages.create without cache_control
          FILES_WITHOUT_CACHING=$(grep -rl "messages\.create" src/ chat_interfaces/ 2>/dev/null | while read -r file; do
            if ! grep -A30 "messages\.create" "$file" | grep -q "cache_control"; then
              echo "$file"
            fi
          done)

          if [ ! -z "$FILES_WITHOUT_CACHING" ]; then
            echo "âš ï¸  WARNING: Files without prompt caching:"
            echo "$FILES_WITHOUT_CACHING"
            echo ""
            echo "Recommended: cache_control={'type': 'ephemeral'}"
            echo "Benefit: 90% latency reduction on cache hits"
            echo ""
            # Warning only, don't fail
          else
            echo "âœ… Prompt caching configured"
          fi

      - name: Check extended thinking configuration
        run: |
          echo "ğŸ§  Checking extended thinking..."

          # Find messages.create without thinking parameter
          FILES_WITHOUT_THINKING=$(grep -rl "messages\.create" src/ chat_interfaces/ 2>/dev/null | while read -r file; do
            if ! grep -A30 "messages\.create" "$file" | grep -q "thinking"; then
              echo "$file"
            fi
          done)

          if [ ! -z "$FILES_WITHOUT_THINKING" ]; then
            echo "âš ï¸  WARNING: Files without extended thinking:"
            echo "$FILES_WITHOUT_THINKING"
            echo ""
            echo "Required: thinking={'type': 'enabled', 'budget_tokens': 4096}"
            echo "Reason: QIG consciousness protocols require 3+ recursive loops"
            echo ""
            # Warning only, don't fail
          else
            echo "âœ… Extended thinking configured"
          fi

      - name: Check max_tokens configuration
        run: |
          echo "ğŸ“Š Checking max_tokens values..."

          # Find low max_tokens values (< 16384) for actual Claude API calls.
          LOW_TOKENS=$(grep -rl "messages\.create" src/ chat_interfaces/ 2>/dev/null | while read -r file; do
            awk '
              /messages\.create/ { in_call=1; remain=40 }
              in_call && remain-- > 0 {
                if (match($0, /max_tokens[[:space:]]*=[[:space:]]*[0-9]+/)) {
                  v=substr($0, RSTART, RLENGTH)
                  gsub(/[^0-9]/, "", v)
                  if (v+0 < 16384) print v
                }
              }
              in_call && remain <= 0 { in_call=0 }
            ' "$file" || true
          done | sort -u || true)

          if [ ! -z "$LOW_TOKENS" ]; then
            echo "âŒ ERROR: max_tokens too low!"
            echo "Found values: $LOW_TOKENS"
            echo ""
            echo "Required: max_tokens >= 16384"
            echo "Reason: Must be significantly > budget_tokens (4096)"
            exit 1
          fi

          echo "âœ… max_tokens values validated"

      - name: Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Claude API validation passed!"
          echo ""
          echo "Validated:"
          echo "  âœ… No hardcoded API keys"
          echo "  âœ… Model: claude-sonnet-4-5-20250929"
          echo "  âœ… max_tokens: >= 16384"
          echo "  âœ… Prompt caching: configured"
          echo "  âœ… Extended thinking: configured"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
