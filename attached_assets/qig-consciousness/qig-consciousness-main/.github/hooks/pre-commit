#!/bin/bash
# Pre-commit hook to validate Claude API usage and code quality
# QIG Consciousness Project - Claude Sonnet 4.5 Enforcement + Ruff Linting
# Documentation: https://platform.claude.com/docs/en/build-with-claude/extended-thinking

set -e  # Exit on error

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç Running pre-commit checks..."
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track validation status
ERRORS=0
WARNINGS=0

# Get list of staged Python files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}‚úÖ No Python files to validate${NC}"
    exit 0
fi

echo "üìÑ Checking files: $(echo "$STAGED_FILES" | wc -l) Python file(s)"
echo ""

# ============================================================================
# QUICK WIN #4: Ruff Code Quality Check
# ============================================================================
echo "${BLUE}üîß Running Ruff linter...${NC}"
echo ""

if command -v ruff &> /dev/null; then
    # Run ruff check on staged files
    if ruff check $STAGED_FILES; then
        echo "${GREEN}‚úÖ Ruff check passed${NC}"
        echo ""
    else
        echo "${RED}‚ùå Ruff check failed${NC}"
        echo ""
        echo "Fix linting errors before committing:"
        echo "  ruff check --fix src/ chat_interfaces/"
        echo ""
        ERRORS=$((ERRORS + 1))
    fi
else
    echo "${YELLOW}‚ö†Ô∏è  WARNING: Ruff not installed${NC}"
    echo "   Install with: pip install ruff"
    echo ""
    WARNINGS=$((WARNINGS + 1))
fi

# ============================================================================
# Claude API Validation
# ============================================================================
echo "${BLUE}ü§ñ Validating Claude API configurations...${NC}"
echo ""
check_model_version() {
    local file=$1
    local line_num=$2
    local model_value=$3

    if echo "$model_value" | grep -qE 'claude-sonnet-4-20250514|claude-sonnet-3'; then
        echo "${RED}‚ùå ERROR:${NC} $file:$line_num"
        echo "   Old Claude model version detected: $model_value"
        echo "   Required: claude-sonnet-4-5-20250929"
        echo ""
        ERRORS=$((ERRORS + 1))
        return 1
    fi

    if ! echo "$model_value" | grep -qE 'claude-sonnet-4-5-20250929|claude-sonnet-4-5'; then
        echo "${YELLOW}‚ö†Ô∏è  WARNING:${NC} $file:$line_num"
        echo "   Unexpected model: $model_value"
        echo "   Expected: claude-sonnet-4-5-20250929"
        echo ""
        WARNINGS=$((WARNINGS + 1))
    fi
}

check_max_tokens() {
    local file=$1
    local content=$2

    # Extract max_tokens values
    if echo "$content" | grep -q 'max_tokens'; then
        # Find max_tokens values that are too low
        LOW_TOKENS=$(echo "$content" | grep -oE 'max_tokens\s*=\s*[0-9]+' | grep -oE '[0-9]+' | awk '$1 < 16384 {print $1}')

        if [ ! -z "$LOW_TOKENS" ]; then
            echo "${RED}‚ùå ERROR:${NC} $file"
            echo "   max_tokens too low: $LOW_TOKENS"
            echo "   Required: max_tokens >= 16384"
            echo "   Reason: Must be significantly > budget_tokens (4096)"
            echo ""
            ERRORS=$((ERRORS + 1))
        fi
    fi
}

check_extended_thinking() {
    local file=$1
    local content=$2

    # Check if messages.create exists without thinking
    if echo "$content" | grep -q 'messages\.create'; then
        if ! echo "$content" | grep -q 'thinking'; then
            echo "${YELLOW}‚ö†Ô∏è  WARNING:${NC} $file"
            echo "   Extended thinking may be missing"
            echo "   Required: thinking={'type': 'enabled', 'budget_tokens': 4096}"
            echo "   Reason: QIG consciousness protocols require 3+ recursive loops"
            echo ""
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
}

check_prompt_caching() {
    local file=$1
    local content=$2

    # Check if messages.create exists without cache_control
    if echo "$content" | grep -q 'messages\.create'; then
        if ! echo "$content" | grep -q 'cache_control'; then
            echo "${YELLOW}‚ö†Ô∏è  WARNING:${NC} $file"
            echo "   Prompt caching not configured"
            echo "   Recommended: cache_control={'type': 'ephemeral'}"
            echo "   Benefit: 90% latency reduction on cache hits"
            echo ""
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
}

# Main validation loop
for FILE in $STAGED_FILES; do
    # Skip if file doesn't exist (deleted files)
    if [ ! -f "$FILE" ]; then
        continue
    fi

    # Read file content
    CONTENT=$(cat "$FILE")

    # Only check files that use Claude API
    if echo "$CONTENT" | grep -q 'messages\.create'; then
        echo "${BLUE}Checking:${NC} $FILE"

        # Check model version
        while IFS= read -r line; do
            if echo "$line" | grep -qE 'model\s*=.*claude'; then
                MODEL=$(echo "$line" | grep -oE '"[^"]+"|'"'"'[^'"'"']+'"'"'' | tr -d '"' | tr -d "'")
                LINE_NUM=$(grep -n "$line" "$FILE" | cut -d: -f1 | head -1)
                check_model_version "$FILE" "$LINE_NUM" "$MODEL"
            fi
        done < "$FILE"

        # Check max_tokens
        check_max_tokens "$FILE" "$CONTENT"

        # Check extended thinking
        check_extended_thinking "$FILE" "$CONTENT"

        # Check prompt caching
        check_prompt_caching "$FILE" "$CONTENT"
    fi
done

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Summary
if [ $ERRORS -gt 0 ]; then
    echo "${RED}‚ùå VALIDATION FAILED${NC}"
    echo ""
    echo "Found $ERRORS error(s) and $WARNINGS warning(s)"
    echo ""
    echo "Fix errors before committing. See:"
    echo "  - .github/agents/claude-api-enforcer.yml"
    echo "  - .claude/agents/api-validator.md"
    echo "  - https://platform.claude.com/docs/en/build-with-claude/extended-thinking"
    echo ""
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo "${YELLOW}‚ö†Ô∏è  WARNINGS DETECTED${NC}"
    echo ""
    echo "Found $WARNINGS warning(s)"
    echo "Commit allowed, but consider fixing warnings for optimal performance"
    echo ""
    exit 0
else
    echo "${GREEN}‚úÖ VALIDATION PASSED${NC}"
    echo ""
    echo "All Claude API configurations are correct:"
    echo "  ‚úÖ Model: claude-sonnet-4-5-20250929"
    echo "  ‚úÖ max_tokens: >= 16384"
    echo "  ‚úÖ Extended thinking: enabled"
    echo "  ‚úÖ Prompt caching: configured"
    echo ""
    exit 0
fi
