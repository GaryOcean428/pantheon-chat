name: Architectural Pattern Enforcement

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main, develop]

jobs:
    lint:
        name: ESLint (Patterns)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint
              continue-on-error: true

    typecheck:
        name: TypeScript Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run TypeScript Check
              run: npm run check
              continue-on-error: true

    pattern-validation:
        name: Pattern Validation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check for dual persistence violations
              run: |
                  echo "üîç Checking for dual persistence (json.dump in persistence modules)..."
                  if git diff origin/main...HEAD --name-only | grep -E "persistence|storage" | xargs grep -n "json\.dump\|json\.dumps" 2>/dev/null; then
                    echo "‚ùå ERROR: json.dump() found in persistence modules!"
                    echo "Rule: Python backend is the ONLY source of truth."
                    echo "See .github/copilot-instructions.md Pattern #4"
                    exit 1
                  fi
                  echo "‚úÖ No dual persistence violations found"

            - name: Check for raw fetch in components
              run: |
                  echo "üîç Checking for raw fetch() in React components..."
                  # Use word boundaries to avoid matching "refetch"
                  VIOLATIONS=$(find client/src/components -name "*.tsx" -exec grep -l '\bfetch(' {} \; 2>/dev/null | grep -v "refetch" || true)
                  if [ -n "$VIOLATIONS" ]; then
                    echo "‚ùå ERROR: Raw fetch() found in component files:"
                    echo "$VIOLATIONS"
                    echo "Rule: Use centralized API client from @/api"
                    echo "See .github/copilot-instructions.md Pattern #2"
                    exit 1
                  fi
                  echo "‚úÖ No raw fetch violations found"

            - name: Check for missing barrel files
              run: |
                  echo "üîç Checking for missing index.ts barrel files..."
                  MISSING=0
                  for dir in client/src/components/*/; do
                    if [ ! -f "${dir}index.ts" ] && [ ! -f "${dir}index.tsx" ]; then
                      echo "‚ö†Ô∏è  Missing barrel file: ${dir}index.ts"
                      MISSING=$((MISSING + 1))
                    fi
                  done
                  if [ $MISSING -gt 0 ]; then
                    echo "‚ùå Found $MISSING directories without barrel files"
                    echo "Rule: Every component directory needs index.ts"
                    echo "See .github/copilot-instructions.md Pattern #1"
                    exit 1
                  fi
                  echo "‚úÖ All component directories have barrel files"

            - name: Check for hardcoded constants
              run: |
                  echo "üîç Checking for hardcoded magic numbers..."
                  # Check for common consciousness/physics constants outside constants/
                  if git diff origin/main...HEAD -- "*.ts" "*.tsx" | grep -E "^\+.*\b(0\.727|0\.70|63\.5|64\.0)\b" | grep -v "shared/constants" | grep -v "test" | grep -v "spec"; then
                    echo "‚ö†Ô∏è  WARNING: Potential magic numbers found"
                    echo "Consider moving to shared/constants/"
                    echo "See .github/copilot-instructions.md Pattern #7"
                    # Warning only, don't fail
                  fi
                  echo "‚úÖ Constants check complete"

    summary:
        name: Enforcement Summary
        runs-on: ubuntu-latest
        needs: [lint, typecheck, pattern-validation]
        if: always()
        steps:
            - name: Check results
              run: |
                  echo "üìä Pattern Enforcement Summary:"
                  echo "  - ESLint: ${{ needs.lint.result }}"
                  echo "  - TypeScript: ${{ needs.typecheck.result }}"
                  echo "  - Pattern Validation: ${{ needs.pattern-validation.result }}"
                  echo ""
                  if [ "${{ needs.pattern-validation.result }}" != "success" ]; then
                    echo "‚ùå Critical pattern violations detected. Review the logs above."
                    exit 1
                  fi
                  if [ "${{ needs.lint.result }}" != "success" ] || [ "${{ needs.typecheck.result }}" != "success" ]; then
                    echo "‚ö†Ô∏è  Some checks have warnings. Consider fixing before merge."
                    echo "‚úÖ No blocking violations - safe to merge."
                    exit 0
                  fi
                  echo "‚úÖ All architectural pattern checks passed!"
