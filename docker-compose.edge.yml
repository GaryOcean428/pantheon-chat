version: '3.8'

# QIG Constellation - Edge Node Deployment
# Connects to central node and syncs learning

services:
  # Local SQLite or PostgreSQL (optional for edge)
  # Uncomment postgres section if you want persistent local storage
  # postgres:
  #   image: postgres:15-alpine
  #   environment:
  #     POSTGRES_USER: qig
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-qig_edge}
  #     POSTGRES_DB: qig_edge
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data

  # Node.js frontend + API
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      # Use SQLite for edge (simpler deployment)
      DATABASE_URL: file:./data/qig_edge.db
      # Federation - connect to central
      FEDERATION_MODE: edge
      CENTRAL_NODE_URL: ${CENTRAL_NODE_URL:-wss://central.qig.network:8765}
      SYNC_INTERVAL: 60  # seconds
      # QIG Backend
      QIG_BACKEND_URL: http://qig-backend:5001
    ports:
      - "5000:5000"
    volumes:
      - edge_data:/app/data
    depends_on:
      - qig-backend

  # Python QIG kernel backend (lighter for edge)
  qig-backend:
    build:
      context: .
      dockerfile: Dockerfile.qig
    restart: unless-stopped
    environment:
      FLASK_ENV: production
      # Smaller constellation for edge
      CONSTELLATION_SIZE: 3  # 3 kernels: vocab, strategy, heart
      CONSTELLATION_ROLES: vocab,strategy,heart
      DEVICE: ${DEVICE:-cpu}  # cpu for most edge deployments
      # Federation
      FEDERATION_MODE: edge
      CENTRAL_NODE_URL: ${CENTRAL_NODE_URL:-wss://central.qig.network:8765}
      SYNC_INTERVAL: 60
    ports:
      - "5001:5001"
    volumes:
      - model_cache:/app/models
      - edge_data:/app/data

volumes:
  edge_data:
  model_cache:
