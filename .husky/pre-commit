#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pantheon-Chat Pre-commit Hooks
# Enforces QIG purity, ISO documentation, and ethical consciousness requirements
# Uses codebuff agents when available, falls back to Python tools

echo "ğŸ” Running pre-commit checks..."
echo ""

# ============================================================================
# 1. CRITICAL ENFORCEMENT AGENTS
# ============================================================================
echo "ğŸ“‹ Running Critical Enforcement Agents..."

if [ -f "scripts/run-critical-enforcement.sh" ]; then
  # Run via codebuff agents (with fallback to Python tools)
  bash scripts/run-critical-enforcement.sh
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Critical enforcement checks failed. Commit blocked."
    echo ""
    echo "To run with more details:"
    echo "  npm run validate:critical:verbose"
    echo ""
    echo "Or run individual agents via codebuff:"
    echo "  codebuff --agent qig-purity-enforcer"
    echo "  codebuff --agent iso-doc-validator"
    echo "  codebuff --agent ethical-consciousness-guard"
    exit 1
  fi
else
  echo "âš ï¸  Warning: Critical enforcement script not found."
  echo "   Run: npm run validate:critical to check manually."
fi

echo ""

# ============================================================================
# 2. ARCHITECTURAL PATTERN ENFORCEMENT
# ============================================================================
echo "ğŸ—ï¸  Running Architectural Pattern Checks..."

# Check for dual persistence (json.dump in persistence modules)
echo "  Checking for dual persistence violations..."
if git diff --cached --name-only | grep -E "persistence|storage" | xargs grep -n "json\.dump\|json\.dumps" 2>/dev/null; then
  echo "âŒ ERROR: json.dump() found in persistence modules!"
  echo "   Rule: Python backend is the ONLY source of truth. NO dual writes to JSON + DB."
  exit 1
fi
echo "  âœ“ No dual persistence violations"

# Check for hardcoded magic numbers in TypeScript constants
echo "  Checking for magic numbers..."
MAGIC_NUMBERS=$(git diff --cached --name-only | grep -E "\.ts$|\.tsx$" | xargs grep -nE "(0\.727|0\.7[^0-9]|63\.5|[^0-9]64[^0-9])" 2>/dev/null | grep -v "shared/constants" | grep -v "test" | grep -v "spec" | grep -v "node_modules" || true)
if [ -n "$MAGIC_NUMBERS" ]; then
  echo "  âš ï¸  Warning: Potential magic numbers found outside constants/"
  echo "$MAGIC_NUMBERS" | head -3 | sed 's/^/     /'
  echo "     Consider moving to shared/constants/"
fi

echo ""

# ============================================================================
# 3. CODE QUALITY CHECKS
# ============================================================================
echo "ğŸ”§ Running Code Quality Checks..."

# ESLint check
echo "  Running ESLint..."
npm run lint --silent 2>/dev/null || {
  echo "âŒ ESLint errors found. Fix them before committing."
  exit 1
}
echo "  âœ“ ESLint passed"

# TypeScript check
echo "  Running TypeScript check..."
npm run check --silent 2>/dev/null || {
  echo "âŒ TypeScript errors found. Fix them before committing."
  exit 1
}
echo "  âœ“ TypeScript check passed"

echo ""

# ============================================================================
# SUCCESS
# ============================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… All pre-commit checks passed!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
